'use client';
import { useState } from 'react';
import { createRecommendation, updateInvoicePaymentStatus, updateServiceJobStatus, updateVehicleServiceReminders } from '@/lib/actions/workshop';

export function VehicleWorkflowActions({ vehicleId, invoices, jobs, compact }: { vehicleId: string; invoices: Array<{ id: string }>; jobs: Array<{ id: string }>; compact?: boolean }) {
  const [msg,setMsg]=useState('');
  async function on(fn:()=>Promise<{ok:boolean;error?:string;message?:string}>){const r=await fn();setMsg(r.ok?(r.message??'Saved'):(r.error??'Failed'));}
  return <div className={compact ? 'space-y-3' : 'space-y-3'}><form onSubmit={(e)=>{e.preventDefault();const f=new FormData(e.currentTarget);void on(()=>createRecommendation({vehicleId,title:String(f.get('title')||''),description:String(f.get('description')||''),severity:String(f.get('severity')||'medium') as 'low'|'medium'|'high'}));}} className="rounded border p-3 text-sm space-y-2"><h3 className="font-semibold">Add recommendation</h3><input required name="title" className="w-full rounded border p-2"/><textarea name="description" className="w-full rounded border p-2"/><select name="severity" className="w-full rounded border p-2"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select><button className="rounded bg-black px-3 py-1 text-white">Add</button></form><form onSubmit={(e)=>{e.preventDefault();const f=new FormData(e.currentTarget);void on(()=>updateVehicleServiceReminders({vehicleId,odometerKm:Number(f.get('odometerKm')||0),nextServiceKm:Number(f.get('nextServiceKm')||0),nextServiceDate:String(f.get('nextServiceDate')||'')}));}} className="rounded border p-3 text-sm space-y-2"><h3 className="font-semibold">Mileage/reminders</h3><input name="odometerKm" type="number" className="w-full rounded border p-2"/><input name="nextServiceKm" type="number" className="w-full rounded border p-2"/><input type="date" name="nextServiceDate" className="w-full rounded border p-2"/><button className="rounded bg-black px-3 py-1 text-white">Save</button></form>{invoices.length?<form onSubmit={(e)=>{e.preventDefault();const f=new FormData(e.currentTarget);void on(()=>updateInvoicePaymentStatus({invoiceId:String(f.get('invoiceId')),paymentStatus:String(f.get('paymentStatus')) as 'unpaid'|'partial'|'paid'}));}} className="rounded border p-3 text-sm space-y-2"><h3 className="font-semibold">Update payment</h3><select name="invoiceId" className="w-full rounded border p-2">{invoices.map(i=><option key={i.id} value={i.id}>{i.id}</option>)}</select><select name="paymentStatus" className="w-full rounded border p-2"><option value="unpaid">Unpaid</option><option value="partial">Partial</option><option value="paid">Paid</option></select><button className="rounded bg-black px-3 py-1 text-white">Update</button></form>:null}{jobs.length?<form onSubmit={(e)=>{e.preventDefault();const f=new FormData(e.currentTarget);void on(()=>updateServiceJobStatus({jobId:String(f.get('jobId')),status:String(f.get('status')) as 'open'|'awaiting_approval'|'in_progress'|'completed'|'cancelled'}));}} className="rounded border p-3 text-sm space-y-2"><h3 className="font-semibold">Update job status</h3><select name="jobId" className="w-full rounded border p-2">{jobs.map(j=><option key={j.id} value={j.id}>{j.id}</option>)}</select><select name="status" className="w-full rounded border p-2"><option value="open">Open</option><option value="awaiting_approval">Awaiting approval</option><option value="in_progress">In progress</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option></select><button className="rounded bg-black px-3 py-1 text-white">Update</button></form>:null}{msg?<p className="text-xs">{msg}</p>:null}</div>;
}
